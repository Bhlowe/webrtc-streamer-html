<html>
<head>
<script src="libs/request.min.js" ></script>
<script src="libs/ag-grid.min.js"></script>
<script src="janusvideoroom.json" ></script>
<script src="janusvideoroom.js" ></script>
<script src="webrtcstreamer.js" ></script>
<style media="screen" type="text/css">
video {
    display: block; 
    margin: 0 auto;
}
button {
    display: block; 
    margin: 0 auto;
}
</style> 
</head>
<body> 
	Janus Url:<input id="janusUrl" type="text" size="50" /> 
	Room id:<input id="janusRoom" type="number" />
	<div id="myGrid" style="height: 80%;" class="ag-fresh"></div>
</body>
<script>
	// set default value
	document.querySelector('#janusUrl').value  = janusRoomConfig.url;
	document.querySelector('#janusRoom').value = janusRoomConfig.roomId;

	var janus;	
	
	// columns
	var columnDefs = [
	    { headerName: "Video"  , field: "video",  width:72,  cellRenderer: function(params) { return "<video onclick='window.open(\"/webrtcstream.html?video=" + params.data.url + "\")' width=\"72\" height=\"60\" id=\"" + params.data.url + "\"/>"; } },
	    { headerName: "Url"    , field: "url"    },
	    { headerName: "Status" , field: "status", cellRenderer: function(params) { return '<b>' + params.value.toUpperCase() + '</b>'; } },
	    { headerName: "RoomId" , field: "roomid" },
	    { headerName: "Action" , 
	      field: "action", 
	      cellRenderer: function(params) { 
	        var eDiv = document.createElement('div');
	        var eButton = document.createElement('button');
		eButton.innerHTML = params.value;
		eDiv.appendChild(eButton);
		eButton.addEventListener('click', function() {
			if (params.value === "join") {
				params.data.roomid = document.querySelector('#janusRoom').value;
				params.api.refreshCells([params.node], ['roomid']);
				
				if (!janus) {
					janus = new JanusVideoRoom(document.querySelector('#janusUrl').value, null, request);
					janus.subscribeEvents(clientCallBack);
				}
				janus.join(parseInt(params.data.roomid), params.data.url, params.data.url);
				
			} else {
				janus.leave(parseInt(params.data.roomid), params.data.url, params.data.url);
			}
		});

		return eDiv;
              } 
	    }
	];

	// options
	var gridOptions = {
		enableFilter: true,
		enableSorting: true,
		enableColResize: true,
		columnDefs: columnDefs,
		rowHeight: 60,
		onGridReady: function($event) { $event.api.sizeColumnsToFit(); }
	};
	
	// fill grid
	new agGrid.Grid(document.querySelector('#myGrid'), gridOptions);	

	function clientCallBack(name, status) {		
		var updatedNodes = [];
		gridOptions.api.forEachNode( function(node) {
			var data = node.data;
			if (data.url === name) {
			    data.status = status;
			    if (status === "up") {
				data.action = "leave";
			    } else if (status === "down") {
				data.roomid = "";
				data.action = "join";
			    }
			    updatedNodes.push(node);
			}
		});
		gridOptions.api.refreshCells({rowNodes:updatedNodes, columns:['status','action','roomid']});
	}
	
	// ------------------------------------------
	// init device list 
	// ------------------------------------------	
	function onGetDeviceList(remoteDeviceList) {
	
		var rowData = [];
		remoteDeviceList.forEach(function(item) {
			rowData.push({url: item , status:"down", action:"join" })
		});
		gridOptions.api.setRowData(rowData);
		
		// connect video
		gridOptions.api.forEachNode( function(node) {
			var data = node.data;
			node.webrtc = new WebRtcStreamer(data.url, null, request)
			node.webrtc.connect(data.url);
		});
	}
	
	// load
	window.onload         = function() { 
		request( 'GET',  "/getVideoDeviceList" ).done(
			function (response) {
				if (response.statusCode === 200) { onGetDeviceList(JSON.parse(response.body)) }
			})
	} 
	
	// unload
	window.onbeforeunload = function() { 
		gridOptions.api.forEachNode( function(node) {
			if (node.webrtc) {
				node.webrtc.disconnect();
				node.webrtc = null;
			}
		});
	}
</script>
</html>


<html>
<head>
<title>WebRTC Streamer</title>
<style media="screen" type="text/css">
nav {
    background-color: #333;
    overflow: hidden;
}
nav a {
    float: left;
    display: block;
    color: #f2f2f2;
    text-align: center;
    padding: 14px 16px;
    text-decoration: none;
    font-size: 17px;
}
nav a:hover {
    background-color: #ddd;
    color: black;
}
nav a.active {
    background-color: #4CAF50;
    color: white;
}
video {
	display:block; 
	margin: 0 auto;
}
</style> 
<script src="ajax.js" ></script>
<script src="webrtcstreamer.js" ></script>
<script>		
	var webRtcServerList = []
	
	// ------------------------------------------
	// init device list 
	// ------------------------------------------	
	function onGetDeviceList(request) {
		var deviceList = [];
                var argurl = location.search.slice(1);
                if (argurl) {
			deviceList.push( [argurl] );
		}
		var remoteDeviceList = JSON.parse(request.responseText);
		if (remoteDeviceList) {
			deviceList.push.apply( deviceList, remoteDeviceList );
		}

		var urllist = document.getElementById("menu");
		for (var dev in deviceList) {
			var option = document.createElement("a");
			option.href = "javascript:add('" + deviceList[dev] + "')";
			option.text = deviceList[dev];
			option.id   = "nav_" +deviceList[dev];
			urllist.appendChild(option);
		}
	}
		
	// ------------------------------------------
	// add a webrtc client connection
	// ------------------------------------------	
	function add(url) {
		var videoTag = "video_" + url;
		
		// add a video element to display webrtc stream
		if (document.getElementById (videoTag) === null) {
			var videoelt = document.createElement("video");
			videoelt.id = videoTag;
			document.body.appendChild(videoelt);
		}
		var videoelt = 	document.getElementById (videoTag);
		
		// connect videoelement to webrtc stream
		var webRtcServer = new WebRtcStreamer(videoTag);
		webRtcServer.connect(url);
			
		// highlight the navigation 
		var navElt = 	document.getElementById ("nav_" + url);
		navElt.className = "active";

		videoelt.onclick = function() {
			// close the connection
			webRtcServer.disconnect(); 
			// remove the video element
			document.body.removeChild(videoelt); 
			// unhighlight the navigation
			navElt.className = "";
		}			

		// register webrtc streamer connection
		webRtcServerList.push(webRtcServer);		
	}
	
	// ------------------------------------------
	// load/unload callbacks
	// ------------------------------------------	
	window.onload         = function() { send("/getDeviceList", null, null, onGetDeviceList); } 
	window.onbeforeunload = function() { for (var webrtclient in webRtcServerList) { webrtclient.disconnect() } };	
</script>
</head>
<body>
<nav id="menu"></nav>
</body>
</html>

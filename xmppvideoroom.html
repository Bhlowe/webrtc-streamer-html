<html>
<head>
<script src="libs/strophe.min.js" ></script>
<script src="libs/strophe.muc.min.js" ></script>
<script src="libs/strophe.disco.min.js" ></script>
<script src="libs/strophe.jingle.sdp.js"></script>
<script src="libs/jquery-1.12.4.min.js"></script>
<script src="libs/request.min.js"></script>
<script src="xmppvideoroom.js" ></script>
<script src="xmppvideoroom.json" ></script>
<script src="webrtcstreamer.json" ></script>
<link rel="stylesheet" type="text/css" href="styles.css">
</head>
<body> 
	XMPP Url:<input id="xmppServer" type="text" size="50" /> 
	Room id:<input id="xmppRoom" type="text" />
	<input type="button" onclick="openroom()" value="OpenRoom" />
	<nav id="menu"></nav>
</body>
<script>
	// set default value
	document.querySelector('#xmppServer').value  = xmppRoomConfig.url;
	document.querySelector('#xmppRoom').value = xmppRoomConfig.roomId;
		
	// ------------------------------------------
	// XMPP connections
	// ------------------------------------------	
	var XMPPServerList = {};
	
	function getText(url) {
		var text;
		if (url.video) {
			text = url.video + " ";
		}
		if (url.audio) {
			text += url.audio + " ";
		}
		return text;
	}		
	// ------------------------------------------
	// init device list 
	// ------------------------------------------	
	function onGetDeviceList(remoteDeviceList) {
		var deviceList = [];
		if (remoteDeviceList) {
			deviceList.push.apply( deviceList, remoteDeviceList );
		}

		// create navigation menu
		var urllist = document.getElementById("menu");
		for (var dev in deviceList) {
			var url = deviceList[dev];
			var option = document.createElement("a");
			var videoTag = "video_" + JSON.stringify(url);
			option.url = url;
			option.text = getText(url);
			option.id   = "nav_" + videoTag;
			option.onclick = function () { 
				if (this.className === "active") {
					disconnect(this.url.video); 
					this.className = "";							
				} else {
					connect(this.url.video); 
					this.className = "active";							
				}
			}
			urllist.appendChild(option);
		}		
	}		
	request("GET" , webrtcConfig.url + "/api/getMediaList").done( function (response) { 
		onGetDeviceList( JSON.parse(response.body));
	});
		
	function connect(webrtcStream) {	
		var serverName = document.querySelector('#xmppServer').value;
		var roomName = document.querySelector('#xmppRoom').value;
	
		if (!XMPPServerList[serverName]) {
			XMPPServerList[serverName] = new XMPPVideoRoom(serverName, webrtcConfig.url);
		}
		var xmpp = XMPPServerList[serverName];
		xmpp.join(roomName, webrtcStream, webrtcStream);
	}
	
	function disconnect(webrtcStream) {
		var serverName = document.querySelector('#xmppServer').value;
		var roomName = document.querySelector('#xmppRoom').value;

		var xmpp = XMPPServerList[serverName];
		if (xmpp) {
			xmpp.leave(roomName, webrtcStream);
		}
	}
	
	function openroom() {
		var serverName = document.querySelector('#xmppServer').value;
		var roomName = document.querySelector('#xmppRoom').value;		
		window.open( location.protocol + "//" + serverName + "/" + roomName);
	}

	window.onbeforeunload = function() { 
		XMPPServerList.entries().forEach( ([serverName, xmpp]) => {
			xmpp.leaveAll();
		});
	};		
</script>
</html>